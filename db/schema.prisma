// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgres"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// The account of user of Station
// user's wallet address is primary key
model Account {
  id          Int                 @id @default(autoincrement())
  address     String              @unique
  skills      SkillsOnAccounts[]
  tickets     AccountTerminal[]
  initiatives AccountInitiative[]
  data        Json?
}

// Each DAO is represented by a terminal.
// roleNameOverrides overrides default role names
model Terminal {
  id            Int               @id @default(autoincrement())
  ticketAddress String            @unique
  handle        String            @unique
  initiatives   Initiative[]
  roles         Role[]
  tickets       AccountTerminal[]
  data          Json?
}

// A role within a terminal
model Role {
  terminal   Terminal          @relation(fields: [terminalId], references: [id])
  terminalId Int
  localId    Int               @default(autoincrement())
  tickets    AccountTerminal[]
  data       Json?

  @@id([terminalId, localId], name: "terminalRoleId")
}

model AccountTerminal {
  account     Account  @relation(fields: [accountId], references: [id])
  accountId   Int
  terminal    Terminal @relation(fields: [terminalId], references: [id])
  terminalId  Int
  role        Role?    @relation(fields: [terminalId, roleLocalId], references: [terminalId, localId])
  roleLocalId Int?
  joinedAt    DateTime @default(now())
  active      Boolean  @default(true)
  ticketUrl   String?

  @@id([accountId, terminalId])
}

// An initiative within a terminal
model Initiative {
  id             Int                 @id @default(autoincrement())
  terminal       Terminal            @relation(fields: [terminalId], references: [id])
  terminalId     Int
  terminalTicket String
  localId        Int                 @default(autoincrement())
  accounts       AccountInitiative[]
  data           Json?

  @@unique([terminalTicket, localId], name: "terminalInitiative")
}

// Associates accounts with initiatives for applications and contributor membership
model AccountInitiative {
  id           Int                     @id @default(autoincrement())
  account      Account                 @relation(fields: [accountId], references: [id])
  accountId    Int
  initiative   Initiative              @relation(fields: [initiativeId], references: [id])
  initiativeId Int
  createdAt    DateTime                @default(now())
  status       AccountInitiativeStatus @default(APPLIED)
  data         Json?

  @@unique([accountId, initiativeId])
}

model Skill {
  id       Int                @id @default(autoincrement())
  name     String             @unique
  accounts SkillsOnAccounts[]
}

model SkillsOnAccounts {
  skill     Skill   @relation(fields: [skillId], references: [id])
  skillId   Int
  account   Account @relation(fields: [accountId], references: [id])
  accountId Int

  @@id([skillId, accountId])
}

enum AccountInitiativeStatus {
  APPLIED
  INVITED
  CONTRIBUTOR
  INACTIVE
}
