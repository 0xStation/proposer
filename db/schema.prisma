// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgres"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// The account of user of Station
// user's wallet address is primary key
model Account {
  id                  Int                      @id @default(autoincrement())
  address             String                   @unique
  applications        InitiativeApplication[]
  pledgedEndorsements ApplicationEndorsement[]
  skills              SkillsOnAccounts[]
  tickets             AccountTerminal[]
  role                String?
  data                Json?
  joinedAt            DateTime                 @default(now())
}

// Each DAO is represented by a terminal.
// roleNameOverrides overrides default role names
model Terminal {
  id            Int               @id @default(autoincrement())
  ticketAddress String            @unique
  initiatives   Initiative[]
  data          Json?
  tickets       AccountTerminal[]
}

model AccountTerminal {
  account    Account  @relation(fields: [accountId], references: [id])
  accountId  Int
  terminal   Terminal @relation(fields: [terminalId], references: [id])
  terminalId Int
  ticketUrl  String
  active     Boolean

  @@id([accountId, terminalId])
}

// An initiative within a terminal
model Initiative {
  id             Int                     @id @default(autoincrement())
  terminal       Terminal                @relation(fields: [terminalId], references: [id])
  terminalId     Int
  terminalTicket String
  localId        Int                     @default(autoincrement())
  applications   InitiativeApplication[]
  data           Json?

  @@unique([terminalTicket, localId], name: "terminalInitiative")
}

// AKA "application"
model InitiativeApplication {
  id           Int                      @id @default(autoincrement())
  applicant    Account                  @relation(fields: [applicantId], references: [id])
  applicantId  Int
  initiative   Initiative               @relation(fields: [initiativeId], references: [id])
  initiativeId Int
  endorsements ApplicationEndorsement[] //onchain
  createdAt    DateTime                 @default(now())
  data         Json?
}

model Skill {
  id       Int                @id @default(autoincrement())
  name     String             @unique
  accounts SkillsOnAccounts[]
}

model SkillsOnAccounts {
  skill     Skill   @relation(fields: [skillId], references: [id])
  skillId   Int
  account   Account @relation(fields: [accountId], references: [id])
  accountId Int

  @@id([skillId, accountId])
}

//doesn't exist anymore
model ApplicationEndorsement {
  id            Int                   @id @default(autoincrement())
  signature     String
  value         Int
  application   InitiativeApplication @relation(fields: [applicationId], references: [id])
  applicationId Int
  endorser      Account               @relation(fields: [accountId], references: [id])
  accountId     Int
}
